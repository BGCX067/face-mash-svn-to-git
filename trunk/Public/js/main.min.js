
(function(){function getUrlParam(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)");var r=window.location.search.substr(1).match(reg);if(r!=null)return unescape(r[2]);return null;}
$.cookie=function(key,value,options){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(value))||value==null)){options=$.extend({},$.cookie.defaults,options);if(value==null){options.expires=-1;}
if(typeof options.expires==='number'){var days=options.expires,t=options.expires=new Date();t.setDate(t.getDate()+days);}
value=String(value);return(document.cookie=[encodeURIComponent(key),'=',options.raw?value:encodeURIComponent(value),options.expires?'; expires='+options.expires.toUTCString():'',options.path?'; path='+options.path:'',options.domain?'; domain='+options.domain:'',options.secure?'; secure':''].join(''));}
options=value||$.cookie.defaults||{};var decode=options.raw?function(s){return s;}:decodeURIComponent;var cookies=document.cookie.split('; ');for(var i=0,parts;(parts=cookies[i]&&cookies[i].split('='));i++){if(decode(parts.shift())===key){return decode(parts.join('='));}}
return null;};$.cookie.defaults={};$.fn.reveal=function(options){var defaults={animation:'fadeAndPop',animationspeed:300,closeonbackgroundclick:true,dismissmodalclass:'close-reveal-modal'};var options=$.extend({},defaults,options);return this.each(function(){var modal=$(this),topMeasure=parseInt(modal.css('top')),topOffset=modal.height()+topMeasure,locked=false,modalBG=$('.reveal-modal-bg');if(modalBG.length==0){modalBG=$('<div class="reveal-modal-bg" />').insertAfter(modal);}
modal.bind('reveal:open',function(){modalBG.unbind('click.modalEvent');$('.'+options.dismissmodalclass).unbind('click.modalEvent');if(!locked){lockModal();if(options.animation=="fadeAndPop"){modal.css({'top':$(document).scrollTop()-topOffset,'opacity':0,'visibility':'visible'});modalBG.fadeIn(options.animationspeed/2);modal.delay(options.animationspeed/2).animate({"top":$(document).scrollTop()+topMeasure+'px',"opacity":1},options.animationspeed,unlockModal());}
if(options.animation=="fade"){modal.css({'opacity':0,'visibility':'visible','top':$(document).scrollTop()+topMeasure});modalBG.fadeIn(options.animationspeed/2);modal.delay(options.animationspeed/2).animate({"opacity":1},options.animationspeed,unlockModal());}
if(options.animation=="none"){modal.css({'visibility':'visible','top':$(document).scrollTop()+topMeasure});modalBG.css({"display":"block"});unlockModal()}}
modal.unbind('reveal:open');});modal.bind('reveal:close',function(){if(!locked){lockModal();if(options.animation=="fadeAndPop"){modalBG.delay(options.animationspeed).fadeOut(options.animationspeed);modal.animate({"top":$(document).scrollTop()-topOffset+'px',"opacity":0},options.animationspeed/2,function(){modal.css({'top':topMeasure,'opacity':1,'visibility':'hidden'});unlockModal();});}
if(options.animation=="fade"){modalBG.delay(options.animationspeed).fadeOut(options.animationspeed);modal.animate({"opacity":0},options.animationspeed,function(){modal.css({'opacity':1,'visibility':'hidden','top':topMeasure});unlockModal();});}
if(options.animation=="none"){modal.css({'visibility':'hidden','top':topMeasure});modalBG.css({'display':'none'});}}
modal.unbind('reveal:close');});modal.trigger('reveal:open')
var closeButton=$('.'+options.dismissmodalclass).bind('click.modalEvent',function(){modal.trigger('reveal:close')});if(options.closeonbackgroundclick){modalBG.css({"cursor":"pointer"})
modalBG.bind('click.modalEvent',function(){modal.trigger('reveal:close')});}
$('body').keyup(function(e){if(e.which===27){modal.trigger('reveal:close');}});function unlockModal(){locked=false;}
function lockModal(){locked=true;}});}
var modaldialog={};(function(){var content=$("#content");var currentPage="vote";var lock={};var dialog=function(m,callback,that){if($.browser.msie&&parseInt($.browser.version,10)<=8){alert(m);if(callback)
that?callback.apply(that):callback.apply();return;}
$("#modal-content p").html(m);$('#modal').reveal({animation:'fade',animationspeed:0,closeonbackgroundclick:true,dismissmodalclass:'close'}).bind("reveal:close",function(){if(callback)
that?callback.apply(that):callback.apply();});}
var ajax=function(method,url,func,opt_showLoading,opt_err_callback,opt_param){var el=$("#global-loading");url=url+"?r="+new Date().getTime();if(opt_showLoading){el.show();el.css("left",parseInt((-el.outerWidth()+$(window).width())/2)+"px");};var proxy=function(data){func(data);if(opt_showLoading)el.hide();};var errProxy=function(data){if(opt_err_callback)opt_err_callback(data);if(opt_showLoading)el.hide();}
return $.ajax({url:url,type:method,success:proxy,error:errProxy,data:opt_param,timeout:META.ajaxTimeout||15000});return f(url,proxy).error(errProxy);}
var opGender=function(gender){return gender=="male"?"female":"male";}
var pageLoadErrCount=0;var showPage=function(pageName){currentPage=pageName;pageName+="_page";track("Navigation",pageName);makeHash(true);var el=$("#content #"+pageName);if(el.children().length>0){$.each(content.children(),function(index,value){$(value).hide();});el.show();}else{ajax("get","/"+"page_"+currentPage,function(data){$.each(content.children(),function(index,value){$(value).hide();});el.show();el.html(data);pageLoadErrCount=0;},true,function(){if(pageLoadErrCount<1)
dialog("请求发送失败，点击确认重试。",function(){showPage(currentPage);});else{dialog("抱歉，服务器暂时无法连接，请您稍后再试。");}
pageLoadErrCount++;});}}
$.each(["vote","top","about"],function(index,value){$("."+value+"_page_btn").click(function(e){$("header nav .active").removeClass("active");$("."+value+"_page_btn").addClass("active");;showPage(value);});});var candCache={setGender:function(gender){$.cookie("g",gender);this._gender=gender;$(document.body).removeClass("male");if(gender=="male")$(document.body).addClass(gender);},init:function(){this.setGender($.cookie("g")||"male");},current:0,_gender:"male",male:0,female:0};var writeCand=function(data){if(candCache.current)$(".cand-img").next().show();data.gender=candCache._gender;candCache.current=data;candCache[data.gender]=data;if(!($("#cand-left")[0]))return;watchImgLoad($(".cand-img"),function(e){$(e.target).removeClass("loading").addClass("loaded").next().hide().next().hide();if(!$("#cand-left").hasClass("loading")&&!$("#cand-right").hasClass("loading")){$(".vote").removeClass("loading");$(".cand-img-loading").hide();$(".up-img").hide();lock.voteLock=false;}},function(){dialog("抱歉，图片加载超时，请点击确认加载下一组",function(){getCand();})});$.each(["left","right"],function(index,value){if($.browser.msie){$("#cand-"+value).addClass("loading").attr("src",(value=="left"?META.img1URL:META.img2URL).replace("%Token%",data[value]));}else{$("#cand-"+value).addClass("loading").attr("src","").attr("src",(value=="left"?META.img1URL:META.img2URL).replace("%Token%",data[value]));}
$("#cand-ac-"+value).html(data["s_"+value]);});$(".vote").removeClass("handsome").removeClass("beautiful").addClass(data.gender=="male"?"handsome":"beautiful");}
var candLoadErrCount=0;var getCand=function(showLoading){if(!lock.getCandLock){lock.getCandLock=true;ajax("get","/candidate",function(data){if(data.err){dialog(data.msg,function(){getCand();});return;}else{writeCand(data);}
lock.getCandLock=false;candLocdErrCount=0;},showLoading,function(){if(candLoadErrCount<1){dialog("加载数据失败，点击确认重新加载。",function(){lock.getCandLock=false;getCand();});}else{dialog("抱歉，暂时无法链接服务器，请您稍后再试。");}
candLoadErrCount++;});}}
$(".candidate .vote").click(function(e,notTrack){onVote(e,notTrack);});function onVote(e,t){if(lock.voteLock)return;lock.voteLock=true;var el=$(e.currentTarget);var type="win";if(el[0].id=="skip-btn")type="skip";if(!candCache.current){getCand(true);return;}
$(".vote").addClass("loading").html("投票中");cand=candCache.current;var winner,loser;if(type=="win"&&META.enableUpArrow){if(el.hasClass("vote-left")){$(".up-img-left").show();}else{$(".up-img-right").show();}}
el.hasClass("vote-left")?((winner=cand.left)&&(loser=cand.right)):((winner=cand.right)&&(loser=cand.left));var args={winner:winner,loser:loser,csrf:cand.csrf};if(type=="skip")args["tie"]=1;ajax("post","/vote",function(data){if(data.err){dialog(data.msg,function(){getCand(true);});}else{writeCand(data);}},false,function(){dialog("抱歉，请求发送失败。",function(){lock.voteLock=false;$(".vote").removeClass("loading")
$(".cand-img").removeClass("loading").next().hide();$(".up-img").hide();})},args);if(!t){var sort=candCache._gender=="male"?"Voting - Boy":"Voting - Girl";var value=el.hasClass("vote-left")?"Win - Left - Btn":"Win - Right - Btn";if(type=="skip")value="Draw - Btn";track(sort,value);}}
$("#skip-btn").click(function(e,notTrack){onVote(e,notTrack);});$(".switch-gender").click(function(e){switchGender(e);track("Navigation","SwitchGender");});function switchGender(){if(lock.getCandLock)return;var gender=candCache.current.gender=="male"?"female":"male";candCache.setGender(gender);makeHash();if(candCache[gender]){writeCand(candCache[gender]);}else{getCand(true);}
var topPage=$("#top_page");var switchTopPage=function(){$(".top_"+gender+"_list").show();$(".top_"+opGender(gender)+"_list").hide();}
if(topPage.children().length==1){$(topPage.children()[0]).addClass("top_"+opGender(gender)+"_list");ajax("get","/page_top",function(data){var el=$(data);topPage.append(el);el.addClass("top_"+gender+"_list");switchTopPage();},true).error(function(){dialog("抱歉，请求发送失败。");});}
if(topPage.children().length==2)switchTopPage();};var watchImgLoad=function(img,suc,err,opt_timeout){var timeout=opt_timeout||META.imgTimeout||15000;var timer=setTimeout(err,timeout);$(img).load(function(e){clearTimeout(timer);suc(e);})}
var scrolling=false;$(document).bind("keydown",function(e){if(!e.keyCode||e.metaKey||e.ctrlKey||e.shiftKey)return;var sort=candCache._gender=="male"?"Voting - Boy":"Voting - Girl";var key="";if(e.keyCode==72){$(".vote-left").trigger("click",true);key="Win - HKey";}else if(e.keyCode==76){$(".vote-right").trigger("click",true);key="Win - LKey";}else if(e.keyCode==75&&!scrolling){scrolling=true;$("html, body").animate({scrollTop:"0px"},400,function(){scrolling=false;});}else if(e.keyCode==74&&!scrolling){scrolling=true;$("html, body").animate({scrollTop:$(document).height()},400,function(){scrolling=false;});}else if(e.keyCode==88){$("#skip-btn").trigger("click",true);key="Draw - XKey";}
track(sort,key);});function track(t,v){_gaq.push(["_trackEvent",t,v]);}
function makeHash(){var hash="#"+currentPage;if(!window.location.hash!=hash){window.location.hash=hash;}}
function hash(){var hash=window.location.hash.replace("#","");$("."+hash+"_page_btn").trigger("click");}
function trackBrowser(){var type="Unknow";var b=$.browser;if(b.msie)type="IE";else if(b.safari)type="Safari";else if(b.webkit)type="WebKit";else if(b.opera)type="Opera";else if(b.mozilla)type="Mozilla";type+=" - "+b.version;track("Browser",type);}
var init=function(){META=window.META;candCache.init();hash();makeHash();getCand();trackBrowser();}
init();})();})();